<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>XSalsa20-Poly1305 Text Encryptor</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data:; base-uri 'none'; form-action 'none'; connect-src 'none';">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --bg:#0f172a;
      --card:#020617;
      --accent:#0ea5e9;
      --accent-dark:#0284c7;
      --border:#1e293b;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#f97373;
      --success:#4ade80;
      --radius:14px;
      --shadow:0 18px 45px rgba(15,23,42,0.8);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:24px;
      min-height:100vh;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,rgba(59,130,246,0.35),transparent 55%),radial-gradient(circle at bottom,rgba(14,165,233,0.2),transparent 55%),var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    .shell{
      max-width:880px;
      margin:0 auto;
    }
    h1{
      font-size:26px;
      margin:4px 0 4px;
      text-align:center;
      letter-spacing:.02em;
      background:linear-gradient(135deg,#38bdf8,#a855f7);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
    }
    .subtitle{
      text-align:center;
      font-size:13px;
      color:var(--muted);
      margin-bottom:20px;
    }
    .subtitle span{color:var(--accent)}
    .card{
      background:radial-gradient(circle at top left,rgba(56,189,248,0.08),transparent 55%),radial-gradient(circle at bottom right,rgba(129,140,248,0.10),transparent 55%),var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
      margin-bottom:18px;
    }
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media(max-width:768px){
      body{padding:14px}
      .grid-2{grid-template-columns:1fr}
    }
    .label{
      display:block;
      font-size:13px;
      font-weight:600;
      margin-bottom:6px;
      color:#e2e8f0;
    }
    textarea,input,button{
      width:100%;
      font-size:14px;
      padding:10px 11px;
      border-radius:10px;
      border:1px solid #1f2937;
      box-sizing:border-box;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    }
    textarea{
      resize:vertical;
      min-height:120px;
      max-height:260px;
      background:rgba(15,23,42,0.95);
      color:var(--text);
    }
    input{
      background:rgba(15,23,42,0.95);
      color:var(--text);
    }
    textarea:focus,input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(14,165,233,0.9);
    }
    .hint{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    .btn{
      border:none;
      border-radius:10px;
      padding:10px 14px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:background .15s ease,transform .12s ease,box-shadow .12s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9,#6366f1);
      color:white;
      box-shadow:0 10px 30px rgba(37,99,235,0.65);
    }
    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 38px rgba(37,99,235,0.9);
    }
    .btn-secondary{
      background:rgba(15,23,42,0.9);
      color:var(--muted);
      border:1px solid #1f2937;
    }
    .btn-secondary:hover{
      background:rgba(15,23,42,1);
      transform:translateY(-1px);
    }
    .btn-ghost{
      background:transparent;
      color:var(--muted);
      border:1px solid #1f2937;
    }
    .btn-ghost:hover{
      background:rgba(15,23,42,0.9);
    }
    .btn-full{width:100%}
    .btn-sm{
      padding:7px 11px;
      font-size:12px;
    }
    .header-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .badge{
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      color:var(--muted);
    }
    .badge-strong{
      border-color:rgba(52,211,153,0.6);
      color:#6ee7b7;
    }
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .status-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-top:6px;
    }
    #status{
      flex:1;
      min-height:1.2em;
    }
    .ok{
      color:var(--success);
      font-weight:600;
      font-size:12px;
    }
    .err{
      color:var(--danger);
      font-weight:600;
      font-size:12px;
    }
    .footer{
      text-align:center;
      font-size:11px;
      color:var(--muted);
      margin-top:12px;
    }
  </style>
</head>
<body>
<div class="shell">
  <h1>XSalsa20-Poly1305 Text Encryptor</h1>
  <div class="subtitle">
    Password-based encryption with PBKDF2-SHA512 · Designed for fully offline use · <span>No tracking or network calls</span>
  </div>

  <div class="card">
    <div class="header-row">
      <div class="badge">Mode: XSalsa20-Poly1305 (TweetNaCl)</div>
      <div class="badge badge-strong">KDF: PBKDF2-HMAC-SHA512</div>
    </div>
    <span class="label">Input</span>
    <textarea id="io" class="mono" placeholder="Plaintext → Encrypt&#10;Ciphertext (Base64URL) → Decrypt" spellcheck="false"></textarea>
    <div class="status-row">
      <div id="status" class="hint"></div>
      <div style="display:flex;gap:8px">
        <button id="copyBtn" class="btn btn-sm btn-secondary">Copy</button>
        <button id="clearBtn" class="btn btn-sm btn-ghost">Clear</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="grid-2">
      <div>
        <span class="label">Password</span>
        <input id="pwd" type="password" class="mono" placeholder="Use a random, high-entropy passphrase" autocomplete="new-password" autocapitalize="off" spellcheck="false">
        <div class="hint">At least 32 random characters recommended.</div>
      </div>
      <div>
        <span class="label">PBKDF2 Iterations</span>
        <input id="iters" type="number" class="mono" min="10000" max="5000000" step="1000" value="200000">
        <div class="hint">Stored in ciphertext header. Enforced policy: 10,000 – 5,000,000.</div>
      </div>
    </div>
    <div style="margin-top:10px">
      <span class="label">AAD Context (optional)</span>
      <input id="aad" type="text" class="mono" placeholder="Additional authenticated data (must match on both sides)">
      <div class="hint">Not encrypted. Authenticated together with header and ciphertext.</div>
    </div>
  </div>

  <div class="card">
    <div class="grid-2">
      <button id="encBtn" class="btn btn-primary btn-full">Encrypt with XSalsa20-Poly1305</button>
      <button id="decBtn" class="btn btn-secondary btn-full">Decrypt and Verify</button>
    </div>
  </div>

  <div class="footer">
    XSalsa20-Poly1305 via TweetNaCl · PBKDF2-SHA512 key stretching · HMAC-SHA512 integrity tag
  </div>
</div>

<script src="nacl.min.js"></script>
<script>
  const enc = new TextEncoder(), dec = new TextDecoder();

  function b64uEncode(u8){
    let s = '', chunk = 0x8000;
    for(let i=0;i<u8.length;i+=chunk){
      s += String.fromCharCode.apply(null, u8.subarray(i, i+chunk));
    }
    return btoa(s).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function b64uDecode(str){
    str = (str||'').replace(/[\r\n\s]/g,'').replace(/-/g,'+').replace(/_/g,'/');
    const pad = str.length % 4 ? '='.repeat(4 - (str.length % 4)) : '';
    const bin = atob(str + pad);
    const u8 = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return u8;
  }
  function concatBytes(...arrs){
    const total = arrs.reduce((a,b)=>a + b.length, 0);
    const out = new Uint8Array(total);
    let off = 0;
    for(const a of arrs){ out.set(a, off); off += a.length; }
    return out;
  }
  function eqBytes(a,b){
    if(a.length !== b.length) return false;
    let v = 0;
    for(let i=0;i<a.length;i++) v |= a[i]^b[i];
    return v===0;
  }

  const VER = 0x01;
  const KDF_PBKDF2 = 0x01;
  const HEADER_LEN = 16 + 24 + 1 + 1 + 4;
  const HMAC_LEN = 64;
  const MIN_ITERS = 10000;
  const MAX_ITERS = 5000000;

  function buildHeader(iter, salt, nonce){
    const hdr = new Uint8Array(HEADER_LEN);
    hdr.set(salt, 0);
    hdr.set(nonce, 16);
    hdr[40] = VER;
    hdr[41] = KDF_PBKDF2;
    new DataView(hdr.buffer).setUint32(42, iter >>> 0, true);
    return hdr;
  }
  function parseAll(u8){
    if(u8.length < HEADER_LEN + HMAC_LEN + 16) throw new Error('Ciphertext too short');
    const salt = u8.slice(0,16);
    const nonce = u8.slice(16,40);
    const ver = u8[40];
    const kdf = u8[41];
    const iter = new DataView(u8.buffer, u8.byteOffset+42, 4).getUint32(0, true);
    const macOff = u8.length - HMAC_LEN;
    const body = u8.slice(HEADER_LEN, macOff);
    const hmac = u8.slice(macOff);
    if(ver !== VER) throw new Error('Version mismatch');
    if(kdf !== KDF_PBKDF2) throw new Error('Unsupported KDF');
    return {iter, salt, nonce, body, hmac, header: u8.slice(0, HEADER_LEN)};
  }

  async function pbkdf2_sha512(passwordUtf8, salt, iterations){
    const keyMat = await crypto.subtle.importKey('raw', passwordUtf8, 'PBKDF2', false, ['deriveBits']);
    const bits = await crypto.subtle.deriveBits({name:'PBKDF2', salt, iterations, hash:'SHA-512'}, keyMat, 512);
    return new Uint8Array(bits);
  }
  async function hmac_sha512(keyRaw32, data){
    const key = await crypto.subtle.importKey('raw', keyRaw32, {name:'HMAC', hash:'SHA-512'}, false, ['sign']);
    const sig = await crypto.subtle.sign('HMAC', key, data);
    return new Uint8Array(sig);
  }

  const $io = document.getElementById('io');
  const $pwd = document.getElementById('pwd');
  const $iters = document.getElementById('iters');
  const $aad = document.getElementById('aad');
  const $encBtn = document.getElementById('encBtn');
  const $decBtn = document.getElementById('decBtn');
  const $copy = document.getElementById('copyBtn');
  const $clear = document.getElementById('clearBtn');
  const $status = document.getElementById('status');

  function setStatus(msg, ok){
    if(!msg){
      $status.textContent = '';
      $status.className = 'hint';
      return;
    }
    $status.textContent = msg;
    $status.className = ok ? 'ok' : 'err';
  }
  function failAuth(){
    setStatus('Decryption failed: password or AAD mismatch (authentication failed)', false);
  }

  (function envCheck(){
    if(typeof crypto === 'undefined' || !crypto.getRandomValues) alert('Missing secure RNG (crypto.getRandomValues).');
    if(!crypto.subtle) alert('Missing WebCrypto SubtleCrypto.');
  })();

  $encBtn.onclick = async () => {
    try{
      setStatus('');
      const text = ($io.value ?? '').toString();
      const pwd = ($pwd.value ?? '').toString();
      const aadStr = ($aad.value ?? '').toString();
      let iters = parseInt($iters.value||'0',10) || 200000;
      iters = Math.max(MIN_ITERS, Math.min(MAX_ITERS, iters));
      if(!text) throw new Error('Plaintext is empty');
      if(!pwd) throw new Error('Password is empty');
      if(!(window.nacl && nacl.secretbox)) throw new Error('TweetNaCl (nacl.secretbox) not loaded');

      const salt = crypto.getRandomValues(new Uint8Array(16));
      const nonce = crypto.getRandomValues(new Uint8Array(24));
      const k64 = await pbkdf2_sha512(enc.encode(pwd), salt, iters);
      const encKey = k64.slice(0,32);
      const macKey = k64.slice(32,64);
      const msg = enc.encode(text);
      const box = nacl.secretbox(msg, nonce, encKey);
      const header = buildHeader(iters, salt, nonce);
      const aad = aadStr ? enc.encode(aadStr) : new Uint8Array(0);
      const mac = await hmac_sha512(macKey, concatBytes(header, box, aad));
      const out = concatBytes(header, box, mac);
      const b64u = b64uEncode(out);

      $io.value = b64u;
      setStatus('Encryption complete', true);

      salt.fill(0); nonce.fill(0); encKey.fill(0); macKey.fill(0); k64.fill(0);
    }catch(e){
      setStatus('Encryption failed: ' + (e.message || e), false);
    }
  };

  $decBtn.onclick = async () => {
    try{
      setStatus('');
      const b64u = ($io.value ?? '').toString();
      const pwd = ($pwd.value ?? '').toString();
      const aadStr = ($aad.value ?? '').toString();
      if(!b64u) throw new Error('Ciphertext is empty');
      if(!pwd) throw new Error('Password is empty');
      if(!(window.nacl && nacl.secretbox)) throw new Error('TweetNaCl (nacl.secretbox) not loaded');

      const blob = b64uDecode(b64u);
      const {iter, salt, nonce, body, hmac, header} = parseAll(blob);
      if(iter < MIN_ITERS || iter > MAX_ITERS) throw new Error('Iterations out of policy');

      const k64 = await pbkdf2_sha512(enc.encode(pwd), salt, iter);
      const encKey = k64.slice(0,32);
      const macKey = k64.slice(32,64);
      const aad = aadStr ? enc.encode(aadStr) : new Uint8Array(0);

      const macCalc = await hmac_sha512(macKey, concatBytes(header, body, aad));
      if(!eqBytes(macCalc, hmac)) return failAuth();

      const msg = nacl.secretbox.open(body, nonce, encKey);
      if(!msg) return failAuth();

      const plain = dec.decode(msg);
      $io.value = plain;
      setStatus('Decryption successful (iterations=' + iter + ')', true);

      salt.fill(0); nonce.fill(0); encKey.fill(0); macKey.fill(0); k64.fill(0);
    }catch(e){
      setStatus(e.message || String(e), false);
    }
  };

  $copy.onclick = async () => {
    try{
      if(!$io.value) return setStatus('Nothing to copy', false);
      await navigator.clipboard.writeText($io.value);
      setStatus('Copied to clipboard', true);
      setTimeout(()=>setStatus(''), 1200);
    }catch(e){
      setStatus('Copy failed: ' + (e.message || e), false);
    }
  };
  $clear.onclick = () => {
    $io.value = '';
    setStatus('');
  };
</script>
</body>
</html>
