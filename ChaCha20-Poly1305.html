<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChaCha20 Encryption</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    textarea, input, button { width: 100%; margin: 10px 0; padding: 10px; font-size: 16px; }
    textarea { height: 150px; }
  </style>
</head>
<body>
  <h2>ChaCha20-Poly1305 Encryption/Decryption</h2>

  <label>Text:</label>
  <textarea id="text" placeholder="Enter the text to be encrypted or decrypted..."></textarea>

  <label>Password:</label>
  <input type="password" id="password" placeholder="Enter the encryption password">

  <button onclick="encryptText()">Encrypt</button>
  <button onclick="decryptText()">Decrypt</button>
  <button onclick="copyResult()">Copy Result</button>

  <label>Result:</label>
  <textarea id="result" readonly></textarea>

  <script>
    // TweetNaCl + minimal PBKDF2 for key derivation
    // 基础函数：Base64工具、PBKDF2-SHA256
    function base64Encode(bytes) {
      return btoa(String.fromCharCode(...bytes));
    }

    function base64Decode(str) {
      return new Uint8Array([...atob(str)].map(c => c.charCodeAt(0)));
    }

    async function sha256(message) {
      const data = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(hashBuffer);
    }

    async function deriveKey(password, salt, iterations = 100000) {
      let key = new TextEncoder().encode(password);
      for (let i = 0; i < iterations; i++) {
        const combined = new Uint8Array(salt.length + key.length);
        combined.set(salt);
        combined.set(key, salt.length);
        key = await sha256(combined);
      }
      return key.slice(0, 32);
    }

    async function encryptText() {
      const text = document.getElementById("text").value;
      const password = document.getElementById("password").value;
      if (!text || !password) return alert("Please enter text and password");

      const nonce = crypto.getRandomValues(new Uint8Array(24));
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const key = await deriveKey(password, salt);

      const naclKey = nacl.secretbox.keyLength === 32 ? key : key.slice(0, 32);
      const msgUint8 = new TextEncoder().encode(text);
      const box = nacl.secretbox(msgUint8, nonce, naclKey);

      const output = new Uint8Array(salt.length + nonce.length + box.length);
      output.set(salt);
      output.set(nonce, salt.length);
      output.set(box, salt.length + nonce.length);

      document.getElementById("result").value = base64Encode(output);
    }

    async function decryptText() {
      const base64 = document.getElementById("text").value;
      const password = document.getElementById("password").value;
      if (!base64 || !password) return alert("Please enter the passphrase and password");

      try {
        const data = base64Decode(base64);
        const salt = data.slice(0, 16);
        const nonce = data.slice(16, 40);
        const box = data.slice(40);
        const key = await deriveKey(password, salt);
        const naclKey = nacl.secretbox.keyLength === 32 ? key : key.slice(0, 32);
        const msg = nacl.secretbox.open(box, nonce, naclKey);
        if (!msg) throw new Error("Decryption failure, wrong password or data corruption");
        document.getElementById("result").value = new TextDecoder().decode(msg);
      } catch (err) {
        document.getElementById("result").value = "Decryption failure: " + err.message;
      }
    }

    function copyResult() {
      const result = document.getElementById("result");
      navigator.clipboard.writeText(result.value).then(() => alert("It has been copied to the clipboard!"));
    }
  </script>
  <script src="nacl.min.js"></script>
</body>
</html>
